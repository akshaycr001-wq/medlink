<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedLink | Patient Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #F8FAFC;
        }

        .teal-gradient {
            background: linear-gradient(135deg, #0F766E 0%, #14B8A6 100%);
        }

        [x-cloak] {
            display: none !important;
        }
    </style>
</head>

<body x-data="patientApp()" x-init="init()" class="text-slate-700">

    <nav class="bg-white border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <div class="w-10 h-10 teal-gradient rounded-xl flex items-center justify-center text-white shadow-lg">
                    <i class="fas fa-plus-medical"></i>
                </div>
                <span class="text-2xl font-black text-slate-800 tracking-tight">MedLink</span>
            </div>
            <div class="flex items-center gap-6">
                <span class="hidden md:inline text-sm font-bold text-slate-500 uppercase tracking-widest"
                    x-text="'Welcome, {{ current_user.name }}'"></span>
                <a href="{{ url_for('logout') }}" class="text-slate-400 hover:text-red-500 transition-colors">
                    <i class="fas fa-power-off text-xl"></i>
                </a>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-8">

        <div
            class="mb-10 bg-white rounded-[2.5rem] p-8 shadow-xl shadow-red-500/5 border-2 border-red-50 flex flex-col md:flex-row items-center justify-between gap-6">
            <div class="flex items-center space-x-6">
                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center animate-pulse">
                    <i class="fas fa-satellite-dish text-red-600 text-3xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-black text-slate-900">Emergency Broadcast</h2>
                    <p class="text-slate-500 font-medium">Instantly notify all pharmacies within 5km.</p>
                </div>
            </div>
            <div class="flex flex-col w-full md:w-auto gap-3">
                <input x-model="sosMsg" type="text" placeholder="Medicine Name Needed..."
                    class="px-6 py-4 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-red-500 transition-all font-bold">
                <button @click="sendSOS()"
                    class="px-10 py-5 bg-red-500 hover:bg-red-600 text-white rounded-2xl font-black shadow-lg shadow-red-200 transition-all active:scale-95 uppercase text-xs tracking-widest">
                    Broadcast SOS
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">

                <div class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                    <h3 class="text-xl font-black mb-6 flex items-center space-x-3">
                        <i class="fas fa-search text-teal-600"></i>
                        <span>Medicine Stock Enquiry</span>
                    </h3>
                    <div class="relative mb-8">
                        <input type="text" x-model="query" @input.debounce.500ms="filterMeds()"
                            placeholder="Search brand or generic name..."
                            class="w-full pl-14 pr-6 py-5 bg-slate-50 border border-slate-100 rounded-[1.5rem] focus:ring-4 focus:ring-teal-500/10 focus:border-teal-500 outline-none transition-all font-bold">
                        <i class="fas fa-pills absolute left-6 top-1/2 -translate-y-1/2 text-slate-300"></i>
                    </div>

                    <!-- Alternative Medicine Banner -->
                    <div x-show="showingAlternatives" x-cloak
                        class="mb-6 p-6 bg-amber-50 border-2 border-amber-200 rounded-3xl">
                        <div class="flex items-start gap-4">
                            <div
                                class="w-12 h-12 bg-amber-100 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exchange-alt text-amber-600 text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-black text-amber-900 text-lg mb-1">Alternative Medicines Available</h4>
                                <p class="text-sm text-amber-700 font-medium">
                                    "<span x-text="originalSearch" class="font-black"></span>" is not available.
                                    Showing similar alternatives below:
                                </p>
                            </div>
                        </div>
                    </div>

                    <div x-show="results.length > 0" x-cloak class="mt-8 space-y-4">
                        <template x-for="res in results" :key="res.id">
                            <div
                                :class="res.is_alternative ? 
                                'p-6 bg-amber-50 rounded-3xl border-2 border-amber-200 hover:bg-amber-100 hover:shadow-lg transition-all space-y-4 group' : 
                                'p-6 bg-slate-50 rounded-3xl border border-transparent hover:bg-white hover:shadow-lg transition-all space-y-4 group'">

                                <!-- Alternative Badge -->
                                <div x-show="res.is_alternative"
                                    class="inline-block px-3 py-1 bg-amber-200 text-amber-800 rounded-full text-[9px] font-black uppercase tracking-widest mb-2">
                                    <i class="fas fa-exchange-alt mr-1"></i> Alternative
                                </div>
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-black text-slate-900 text-lg" x-text="res.name"></h4>
                                        <p class="text-[10px] text-teal-600 font-black uppercase tracking-widest"
                                            x-text="res.pharmacy"></p>
                                        <!-- Location Feature -->
                                        <p class="text-xs text-slate-500 mt-1"
                                            x-text="res.location || 'Location not specified'"></p>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-2xl font-black text-slate-900" x-text="'â‚¹' + res.price"></p>
                                        <p class="text-[10px] font-black text-slate-400 mt-1"
                                            x-text="res.dist + ' km away'"></p>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-2 pt-2 border-t border-slate-100">
                                    <a :href="'tel:' + res.phone"
                                        class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest hover:text-teal-600 transition-all">
                                        <i class="fas fa-phone mr-1"></i> Call Store
                                    </a>
                                    <a :href="'https://wa.me/' + res.phone + '?text=Is ' + res.name + ' available?'"
                                        target="_blank"
                                        class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest hover:text-green-600 transition-all">
                                        <i class="fab fa-whatsapp mr-1"></i> Enquiry
                                    </a>
                                    <button @click="openReview(res)"
                                        class="px-4 py-2 bg-white border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-900 hover:text-white transition-all">
                                        <i class="fas fa-star text-amber-400 mr-1"></i> Rate Pharmacy
                                    </button>
                                    <template x-if="res.lat && res.lng">
                                        <a :href="'https://www.google.com/maps?q=' + res.lat + ',' + res.lng"
                                            target="_blank"
                                            class="px-4 py-2 bg-teal-50 text-teal-600 border border-teal-100 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-teal-600 hover:text-white transition-all">
                                            <i class="fas fa-location-dot mr-1"></i> View on Maps
                                        </a>
                                    </template>
                                    <template x-if="!res.lat || !res.lng">
                                        <a :href="'https://www.google.com/maps/search/' + encodeURIComponent(res.pharmacy + ' ' + (res.location || ''))"
                                            target="_blank"
                                            class="px-4 py-2 bg-slate-50 text-slate-600 border border-slate-200 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-900 hover:text-white transition-all">
                                            <i class="fas fa-search-location mr-1"></i> Search Location
                                        </a>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                    <div x-show="results.length === 0 && query.length > 1"
                        class="text-center text-slate-400 font-bold mt-4">
                        No medicines found.
                    </div>
                </div>

                <div class="bg-white rounded-[2.5rem] p-10 shadow-sm border border-slate-100">
                    <h3 class="text-xl font-black mb-8 flex items-center space-x-3">
                        <i class="fas fa-hospital-user text-teal-600"></i>
                        <span>Nearby Hospitals & Ambulances (15km) </span>
                    </h3>
                    <div class="space-y-6">
                        <template x-for="hosp in nearHospitals" :key="hosp.id">
                            <div class="p-6 border border-slate-100 rounded-3xl bg-slate-50/50">
                                <div class="flex justify-between items-start mb-6">
                                    <div>
                                        <h4 class="font-black text-slate-800 text-lg" x-text="hosp.name"></h4>
                                        <p class="text-xs text-slate-400 font-bold uppercase tracking-tighter"
                                            x-text="'Hosp: ' + hosp.phone"></p>
                                        <p class="text-[10px] text-teal-600 font-black mt-1"
                                            x-text="hosp.distance + ' km away'"></p>
                                    </div>
                                    <a :href="hosp.latitude && hosp.longitude ? 'https://www.google.com/maps?q=' + hosp.latitude + ',' + hosp.longitude : 'https://www.google.com/maps/search/' + encodeURIComponent(hosp.name)"
                                        target="_blank"
                                        class="px-4 py-2 bg-teal-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest shadow-md hover:bg-teal-700 transition-all">
                                        <i class="fas fa-location-dot mr-1"></i> Maps
                                    </a>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div
                                        class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                                        <div>
                                            <p class="text-[9px] font-black text-slate-400 uppercase">Ambulance Desk</p>
                                            <p class="text-xs font-bold text-slate-800"
                                                x-text="hosp.ambulance_no || 'N/A'"></p>
                                        </div>
                                        <a :href="'tel:' + hosp.ambulance_no" x-show="hosp.ambulance_no"
                                            class="w-8 h-8 flex items-center justify-center bg-red-50 text-red-600 rounded-lg"><i
                                                class="fas fa-phone"></i></a>
                                    </div>
                                    <div
                                        class="p-4 bg-white rounded-2xl shadow-sm border border-slate-100 flex items-center justify-between">
                                        <div>
                                            <p class="text-[9px] font-black text-slate-400 uppercase"
                                                x-text="'Driver: ' + (hosp.driver_name || 'N/A')"></p>
                                            <p class="text-xs font-bold text-slate-800"
                                                x-text="hosp.driver_no || 'N/A'"></p>
                                        </div>
                                        <a :href="'tel:' + hosp.driver_no" x-show="hosp.driver_no"
                                            class="w-8 h-8 flex items-center justify-center bg-slate-100 text-slate-600 rounded-lg"><i
                                                class="fas fa-phone"></i></a>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div x-show="nearHospitals.length === 0" class="text-center py-10 text-slate-400 font-bold">
                            No hospitals found within 15km.
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-8">
                <div class="teal-gradient rounded-[2.5rem] p-10 shadow-xl text-white">
                    <h3 class="text-xl font-black mb-4">Network Safety</h3>
                    <p class="text-sm font-medium opacity-80 mb-6 leading-relaxed">Connecting you to verified hospitals
                        and ambulances within your radius.</p>
                    <div class="space-y-3 pt-4 border-t border-white/20">
                        <div class="flex justify-between text-xs font-bold uppercase tracking-widest">
                            <span>Nearby Hospitals</span>
                            <span>{{ hospitals|length }}</span>
                        </div>
                        <div class="flex justify-between text-xs font-bold uppercase tracking-widest">
                            <span>Active Radius</span>
                            <span>5 km</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div x-show="reviewModal" x-cloak
        class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6">
        <div class="bg-white rounded-[3rem] max-w-md w-full p-10 animate-in zoom-in duration-300">
            <h2 class="text-2xl font-black text-slate-900 mb-2">Rate <span x-text="selectedPharma.pharmacy"></span></h2>
            <p class="text-slate-500 text-sm mb-6 font-medium">Your feedback helps others find reliable pharmacies.</p>

            <div class="flex justify-center gap-2 mb-8 text-2xl text-amber-400">
                <template x-for="i in 5">
                    <i class="cursor-pointer" :class="i <= rating ? 'fas fa-star' : 'far fa-star'"
                        @click="rating = i"></i>
                </template>
            </div>

            <textarea x-model="reviewText" placeholder="Write your experience..."
                class="w-full p-5 bg-slate-50 border border-slate-200 rounded-2xl outline-none focus:border-teal-500 font-medium text-sm h-32 mb-6"></textarea>

            <div class="grid grid-cols-2 gap-4">
                <button @click="reviewModal = false"
                    class="py-4 bg-slate-100 text-slate-600 rounded-2xl font-black uppercase text-xs tracking-widest hover:bg-slate-200">Cancel</button>
                <button @click="submitReview()"
                    class="py-4 teal-gradient text-white rounded-2xl font-black uppercase text-xs tracking-widest shadow-lg shadow-teal-700/20">Submit</button>
            </div>
        </div>
    </div>

    <script>
        function patientApp() {
            return {
                query: '', sosMsg: '', results: [], reviewModal: false,
                selectedPharma: {}, rating: 5, reviewText: '',
                showingAlternatives: false, originalSearch: '',
                nearHospitals: [], userLat: null, userLng: null,

                init() {
                    console.log('Terminal Ready');
                    this.getUserLocation();
                },

                getUserLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                this.userLat = pos.coords.latitude;
                                this.userLng = pos.coords.longitude;
                                this.fetchNearbyHospitals();
                            },
                            (err) => {
                                console.warn('Geolocation denied or failed, showing all hospitals');
                                this.fetchNearbyHospitals();
                            }
                        );
                    } else {
                        this.fetchNearbyHospitals();
                    }
                },

                async fetchNearbyHospitals() {
                    let url = '/patient/nearby_hospitals';
                    if (this.userLat && this.userLng) {
                        url += `?lat=${this.userLat}&lng=${this.userLng}`;
                    }
                    try {
                        const response = await fetch(url);
                        this.nearHospitals = await response.json();
                    } catch (error) {
                        console.error('Error fetching hospitals:', error);
                    }
                },

                async filterMeds() {
                    if (this.query.length < 2) {
                        this.results = [];
                        this.showingAlternatives = false;
                        return;
                    }

                    try {
                        let url = `/patient/search_medicine?query=${this.query}`;
                        if (this.userLat && this.userLng) {
                            url += `&lat=${this.userLat}&lng=${this.userLng}`;
                        }
                        const response = await fetch(url);
                        this.results = await response.json();

                        // Check if we're showing alternatives
                        if (this.results.length > 0 && this.results[0].is_alternative) {
                            this.showingAlternatives = true;
                            this.originalSearch = this.results[0].original_search;
                        } else {
                            this.showingAlternatives = false;
                        }
                    } catch (error) {
                        console.error('Error fetching medicines:', error);
                    }
                },

                async sendSOS() {
                    if (!this.sosMsg) return alert('Enter medicine name');

                    try {
                        const response = await fetch('/patient/send_sos', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token() }}'
                            },
                            body: JSON.stringify({
                                medicine_name: this.sosMsg,
                                latitude: null,
                                longitude: null
                            })
                        });
                        if (response.ok) {
                            alert('SOS Broadcasted to all pharmacies! They will be notified on their terminals.');
                            this.sosMsg = '';
                        }
                    } catch (error) {
                        alert('Error broadcasting SOS');
                    }
                },

                openReview(pharma) {
                    this.selectedPharma = pharma;
                    this.reviewModal = true;
                },

                async submitReview() {
                    try {
                        await fetch('/patient/submit_review', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-Token': '{{ csrf_token() }}'
                            },
                            body: JSON.stringify({
                                pharmacy_name: this.selectedPharma.pharmacy,
                                rating: this.rating,
                                comment: this.reviewText
                            })
                        });
                        alert(`Review submitted for ${this.selectedPharma.pharmacy}!`);
                        this.reviewModal = false;
                        this.reviewText = '';
                    } catch (error) {
                        alert('Error submitting review');
                    }
                }
            }
        }
    </script>
</body>

</html>